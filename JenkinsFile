pipeline {
    agent any
    
    stages {
        stage("checkout") {
            steps {
                checkout scm
            }
        }
        
        stage("Build Image") {
            steps {
                script {
                    def imageName = "myjenkinsapp"
                    def version = ""
                    
                    // Check if the image already exists
                    def imageExists = bat(script: "docker image inspect $imageName", returnStatus: true) == 0
                    
                    // If the image exists, create a new version
                    if (imageExists) {
                        version = bat(script: "docker inspect --format '{{ index .Config.Labels \"version\" }}' $imageName", returnStdout: true).trim()
                        version = version.toInteger() + 1
                    }
                    
                    // Build the Docker image with the new version
                    bat "docker build -t $imageName:$version ."
                }
            }
        }
    }
    
    post {
        success {
            // Mark the build as successful
            script {
                currentBuild.result = 'SUCCESS'
            }
        }
        failure {
            // Mark the build as failed
            script {
                currentBuild.result = 'FAILURE'
            }
        }
    }
}
